"""
Transport cost calculation service.

Refactored to functional style for direct testing and usage.
"""
from app.transport.schemas import (
    VehicleType,
    TransportCompareRequest,
    TransportCompareResponse,
    MandiComparison,
    CostBreakdown,
)
from app.models import Mandi, Commodity, PriceHistory
import math
import httpx
import logging
from typing import List, Optional, Dict, Any, Tuple
from sqlalchemy.orm import Session

logger = logging.getLogger(__name__)


# =============================================================================
# CONSTANTS (Updated with 2026 Indian Market Rates)
# =============================================================================

VEHICLES = {
    VehicleType.TEMPO: {
        "capacity_kg": 2000,
        "cost_per_km": 18.0,  # Increased for diesel ~₹98/L
        "toll_per_plaza": 100,
        "description": "Tata Ace / Mini Truck (up to 2 tons)"
    },
    VehicleType.TRUCK_SMALL: {
        "capacity_kg": 7000,  # Increased capacity (LCV)
        "cost_per_km": 28.0,
        "toll_per_plaza": 200,
        "description": "Light Commercial Vehicle (3-7 tons)"
    },
    VehicleType.TRUCK_LARGE: {
        "capacity_kg": 15000,  # Increased capacity (HCV)
        "cost_per_km": 38.0,
        "toll_per_plaza": 350,
        "description": "Heavy Commercial Vehicle (10-15 tons)"
    },
}

# Loading/unloading costs (Hamali charges)
LOADING_COST_PER_KG = 0.035  # ₹3.5 per quintal
UNLOADING_COST_PER_KG = 0.030  # ₹3.0 per quintal

# Mandi fees (varies by state, using average)
MANDI_FEE_RATE = 0.015  # 1.5%
COMMISSION_RATE = 0.025  # 2.5% agent commission

# Additional charges per trip
WEIGHBRIDGE_FEE = 80.0  # ₹ per weighing
PARKING_FEE = 50.0      # ₹ per trip
DOCUMENTATION_FEE = 70.0  # ₹ per trip (receipts, permits)

# Distance calculations
ROAD_DISTANCE_MULTIPLIER = 1.4  # Haversine to actual road distance
TOLL_PLAZA_SPACING_KM = 60  # Average spacing on highways

DISTRICT_COORDINATES = {
    # =========================================================================
    # ANDHRA PRADESH (26 districts)
    # =========================================================================
    "Anantapur": (14.6819, 77.6006),
    "Chittoor": (13.2172, 79.1003),
    "East Godavari": (17.0005, 81.8040),
    "Guntur": (16.3067, 80.4365),
    "Kadapa": (14.4674, 78.8241),
    "Kakinada": (16.9891, 82.2475),
    "Krishna": (16.5062, 80.6480),
    "Kurnool": (15.8281, 78.0373),
    "Nellore": (14.4426, 79.9865),
    "Ongole": (15.5057, 80.0499),
    "Prakasam": (15.5057, 80.0499),
    "Rajahmundry": (17.0005, 81.8040),
    "Srikakulam": (18.2949, 83.8938),
    "Tirupati": (13.6288, 79.4192),
    "Vijayawada": (16.5062, 80.6480),
    "Visakhapatnam": (17.6868, 83.2185),
    "Vizianagaram": (18.1067, 83.3956),
    "West Godavari": (16.7107, 81.0952),
    "Eluru": (16.7107, 81.0952),
    "Bapatla": (15.9044, 80.4676),
    "Palnadu": (16.2530, 79.7000),
    "Nandyal": (15.4785, 78.4836),
    "Anakapalli": (17.6910, 83.0037),
    "Alluri Sitharama Raju": (17.6000, 81.8000),
    "Konaseema": (16.9500, 82.2400),
    "Parvathipuram Manyam": (18.7700, 84.0900),
    "Sri Sathya Sai": (14.4800, 77.6100),
    "Annamayya": (13.6300, 79.4200),
    "NTR": (16.5062, 80.6480),
    # =========================================================================
    # ARUNACHAL PRADESH (26 districts)
    # =========================================================================
    "Itanagar": (27.1020, 93.6919),
    "Tawang": (27.5860, 91.8700),
    "Bomdila": (27.2615, 92.4239),
    "West Kameng": (27.2615, 92.4239),
    "East Kameng": (27.2791, 92.8080),
    "Seppa": (27.2791, 92.8080),
    "Papum Pare": (27.1020, 93.6919),
    "Ziro": (27.5450, 93.8330),
    "Lower Subansiri": (27.5450, 93.8330),
    "Upper Subansiri": (27.9851, 94.2214),
    "Daporijo": (27.9851, 94.2214),
    "Along": (28.1693, 94.8025),
    "West Siang": (28.1693, 94.8025),
    "East Siang": (28.0665, 95.3260),
    "Pasighat": (28.0665, 95.3260),
    "Upper Siang": (28.5000, 95.3000),
    "Lower Siang": (28.0000, 94.9000),
    "Lower Dibang Valley": (28.1147, 95.8505),
    "Roing": (28.1147, 95.8505),
    "Dibang Valley": (28.8174, 95.8744),
    "Anini": (28.8174, 95.8744),
    "Lohit": (27.9160, 96.1703),
    "Tezu": (27.9160, 96.1703),
    "Namsai": (27.6900, 95.8700),
    "Changlang": (27.1430, 95.7278),
    "Tirap": (26.9997, 95.5482),
    "Khonsa": (26.9997, 95.5482),
    "Longding": (26.8800, 95.3200),
    "Naharlagun": (27.1045, 93.7050),
    "Anjaw": (28.0600, 96.8600),
    "Kamle": (27.7000, 93.9000),
    "Kurung Kumey": (27.8000, 93.4000),
    "Kra Daadi": (27.8500, 93.5000),
    "Pakke Kessang": (27.1000, 93.0000),
    "Lepa Rada": (28.0500, 94.6000),
    "Shi Yomi": (28.3000, 94.2000),
    "Siang": (28.2000, 95.0000),
    # =========================================================================
    # ASSAM (35 districts)
    # =========================================================================
    "Baksa": (26.6900, 91.2500),
    "Barpeta": (26.3210, 91.0062),
    "Biswanath": (26.7300, 93.1500),
    "Bongaigaon": (26.4832, 90.5550),
    "Cachar": (24.8333, 92.7789),
    "Charaideo": (26.9700, 94.8500),
    "Chirang": (26.5500, 90.2300),
    "Darrang": (26.4540, 92.0290),
    "Dhemaji": (27.4700, 94.5800),
    "Dhubri": (26.0190, 89.9867),
    "Dibrugarh": (27.4728, 94.9120),
    "Dima Hasao": (25.5000, 93.0000),
    "Goalpara": (26.1667, 90.6167),
    "Golaghat": (26.5150, 93.9600),
    "Guwahati": (26.1445, 91.7362),
    "Hailakandi": (24.6800, 92.5700),
    "Hojai": (26.0000, 92.8600),
    "Jorhat": (26.7509, 94.2037),
    "Kamrup": (26.1445, 91.7362),
    "Kamrup Metropolitan": (26.1445, 91.7362),
    "Karbi Anglong": (26.0000, 93.5000),
    "Karimganj": (24.8700, 92.3500),
    "Kokrajhar": (26.4000, 90.2700),
    "Lakhimpur": (27.2400, 94.1000),
    "Majuli": (26.9500, 94.1700),
    "Morigaon": (26.2500, 92.3400),
    "Nagaon": (26.3484, 92.6855),
    "Nalbari": (26.4463, 91.4341),
    "Silchar": (24.8333, 92.7789),
    "Sivasagar": (26.9842, 94.6336),
    "Sonitpur": (26.6338, 92.7789),
    "Tezpur": (26.6338, 92.7789),
    "Tinsukia": (27.4900, 95.3600),
    "Udalguri": (26.7500, 92.1000),
    "West Karbi Anglong": (25.8500, 93.1500),
    "South Salmara Mankachar": (25.5000, 89.9000),
    "Bajali": (26.4000, 91.0500),
    "Tamulpur": (26.6200, 91.3500),
    # =========================================================================
    # BIHAR (38 districts)
    # =========================================================================
    "Araria": (26.1496, 87.5148),
    "Arwal": (25.2452, 84.6897),
    "Aurangabad Bihar": (24.7515, 84.3742),
    "Banka": (24.8843, 86.9214),
    "Begusarai": (25.4182, 86.1272),
    "Bhagalpur": (25.2425, 86.9842),
    "Bhojpur": (25.5585, 84.6633),
    "Arrah": (25.5585, 84.6633),
    "Buxar": (25.5764, 83.9777),
    "Darbhanga": (26.1542, 85.8918),
    "East Champaran": (26.6530, 84.8530),
    "Motihari": (26.6530, 84.8530),
    "Gaya": (24.7955, 84.9994),
    "Gopalganj": (26.4672, 84.4383),
    "Jamui": (24.9256, 86.2262),
    "Jehanabad": (25.2133, 84.9876),
    "Kaimur": (25.0473, 83.6080),
    "Katihar": (25.5455, 87.5719),
    "Khagaria": (25.5022, 86.4690),
    "Kishanganj": (26.0915, 87.9312),
    "Lakhisarai": (25.1565, 86.0941),
    "Madhepura": (25.9211, 86.7920),
    "Madhubani": (26.3542, 86.0717),
    "Munger": (25.3708, 86.4735),
    "Muzaffarpur": (26.1209, 85.3647),
    "Nalanda": (25.2026, 85.4443),
    "Nawada": (24.8867, 85.5322),
    "Patna": (25.6093, 85.1376),
    "Purnia": (25.7771, 87.4753),
    "Rohtas": (24.9731, 84.0063),
    "Sasaram": (24.9731, 84.0063),
    "Saharsa": (25.8800, 86.6017),
    "Samastipur": (25.8632, 85.7812),
    "Saran": (25.7830, 84.7375),
    "Chhapra": (25.7830, 84.7375),
    "Sheikhpura": (25.1394, 85.8479),
    "Sheohar": (26.5138, 85.2988),
    "Sitamarhi": (26.5953, 85.4895),
    "Siwan": (26.2242, 84.3572),
    "Supaul": (26.1213, 86.6059),
    "Vaishali": (25.6873, 85.2318),
    "West Champaran": (26.7268, 84.4270),
    "Bettiah": (26.7268, 84.4270),
    # =========================================================================
    # CHHATTISGARH (33 districts)
    # =========================================================================
    "Balod": (20.7300, 81.2000),
    "Baloda Bazar": (21.6600, 82.1600),
    "Balrampur Cg": (23.6100, 83.6000),
    "Bastar": (19.0690, 82.0304),
    "Bemetara": (21.7200, 81.5300),
    "Bijapur Cg": (18.8400, 80.8300),
    "Bilaspur": (22.0796, 82.1391),
    "Dantewada": (18.9000, 81.3500),
    "Dhamtari": (20.7071, 81.5485),
    "Durg": (21.1904, 81.2849),
    "Bhilai": (21.2093, 81.3787),
    "Gariaband": (20.6300, 82.0600),
    "Janjgir Champa": (22.0100, 82.5700),
    "Jashpur": (22.8900, 84.1400),
    "Kabirdham": (22.1000, 81.2500),
    "Kawardha": (22.1000, 81.2500),
    "Kanker": (20.2700, 81.5000),
    "Kondagaon": (19.6000, 81.6600),
    "Korba": (22.3595, 82.7501),
    "Koriya": (23.2500, 82.5800),
    "Mahasamund": (21.1100, 82.1000),
    "Mungeli": (22.0700, 81.6800),
    "Narayanpur": (19.7200, 81.2500),
    "Raigarh": (21.8974, 83.3950),
    "Raipur": (21.2514, 81.6296),
    "Rajnandgaon": (21.0974, 81.0286),
    "Sukma": (18.3900, 81.6600),
    "Surajpur": (23.2100, 82.8700),
    "Surguja": (23.1256, 83.1915),
    "Ambikapur": (23.1256, 83.1915),
    "Jagdalpur": (19.0690, 82.0304),
    # =========================================================================
    # GOA (2 districts)
    # =========================================================================
    "North Goa": (15.5379, 73.8126),
    "South Goa": (15.2832, 74.0855),
    "Panaji": (15.4909, 73.8278),
    "Margao": (15.2832, 73.9862),
    # =========================================================================
    # GUJARAT (33 districts)
    # =========================================================================
    "Ahmedabad": (23.0225, 72.5714),
    "Amreli": (21.5929, 71.2224),
    "Anand": (22.5645, 72.9289),
    "Aravalli": (24.0100, 73.0200),
    "Banaskantha": (24.1700, 72.4300),
    "Palanpur": (24.1700, 72.4300),
    "Bharuch": (21.7051, 72.9959),
    "Bhavnagar": (21.7645, 72.1519),
    "Botad": (22.1700, 71.6700),
    "Chhota Udaipur": (22.3100, 74.0100),
    "Dahod": (22.8374, 74.2528),
    "Dang": (20.7537, 73.6832),
    "Ahwa": (20.7537, 73.6832),
    "Devbhoomi Dwarka": (22.2000, 69.0800),
    "Gandhinagar": (23.2156, 72.6369),
    "Gir Somnath": (20.8882, 70.3627),
    "Veraval": (20.9000, 70.3700),
    "Jamnagar": (22.4707, 70.0577),
    "Junagadh": (21.5222, 70.4579),
    "Kheda": (22.7500, 72.6800),
    "Nadiad": (22.6916, 72.8634),
    "Kutch": (23.7337, 69.8597),
    "Bhuj": (23.2420, 69.6669),
    "Mahisagar": (23.1100, 73.6300),
    "Mehsana": (23.5880, 72.3693),
    "Morbi": (22.8120, 70.8301),
    "Narmada": (21.8700, 73.5000),
    "Navsari": (20.9467, 72.9520),
    "Panchmahal": (22.6700, 73.6000),
    "Godhra": (22.7788, 73.6143),
    "Patan": (23.8500, 72.1200),
    "Porbandar": (21.6417, 69.6293),
    "Rajkot": (22.3039, 70.8022),
    "Sabarkantha": (23.6300, 73.0400),
    "Himmatnagar": (23.5963, 72.9666),
    "Surat": (21.1702, 72.8311),
    "Surendranagar": (22.7500, 71.6800),
    "Tapi": (21.2500, 73.5000),
    "Vadodara": (22.3072, 73.1812),
    "Valsad": (20.5992, 72.9342),
    # =========================================================================
    # HARYANA (22 districts)
    # =========================================================================
    "Ambala": (30.3782, 76.7767),
    "Bhiwani": (28.7930, 76.1395),
    "Charkhi Dadri": (28.5900, 76.2700),
    "Faridabad": (28.4082, 77.3165),
    "Fatehabad": (29.5152, 75.4550),
    "Gurgaon": (28.4595, 77.0266),
    "Gurugram": (28.4595, 77.0266),
    "Hisar": (29.1492, 75.7217),
    "Jhajjar": (28.6062, 76.6565),
    "Jind": (29.3117, 76.3086),
    "Kaithal": (29.8015, 76.3992),
    "Karnal": (29.6857, 76.9905),
    "Kurukshetra": (29.9695, 76.8783),
    "Mahendragarh": (28.2829, 76.1496),
    "Mewat": (27.7830, 76.9745),
    "Nuh": (27.7830, 76.9745),
    "Palwal": (28.1442, 77.3294),
    "Panchkula": (30.6942, 76.8542),
    "Panipat": (29.3909, 76.9635),
    "Rewari": (28.1989, 76.6194),
    "Rohtak": (28.8955, 76.5897),
    "Sirsa": (29.5361, 75.0289),
    "Sonipat": (28.9947, 77.0155),
    "Yamunanagar": (30.1290, 77.2674),
    # =========================================================================
    # HIMACHAL PRADESH (12 districts)
    # =========================================================================
    "Bilaspur Hp": (31.3408, 76.7564),
    "Chamba": (32.5534, 76.1258),
    "Hamirpur Hp": (31.6842, 76.5214),
    "Kangra": (32.0998, 76.2691),
    "Dharamshala": (32.2190, 76.3234),
    "Kinnaur": (31.5800, 78.4700),
    "Kullu": (31.9579, 77.1095),
    "Lahaul And Spiti": (32.5800, 77.0400),
    "Keylong": (32.5716, 77.0397),
    "Mandi": (31.7087, 76.9318),
    "Shimla": (31.1048, 77.1734),
    "Sirmaur": (30.5700, 77.3000),
    "Nahan": (30.5596, 77.2960),
    "Solan": (30.9045, 77.0967),
    "Una": (31.4685, 76.2708),
    "Palampur": (32.1109, 76.5363),
    # =========================================================================
    # JAMMU & KASHMIR (20 districts)
    # =========================================================================
    "Anantnag": (33.7311, 75.1547),
    "Bandipora": (34.4181, 74.6441),
    "Baramulla": (34.1980, 74.3436),
    "Budgam": (33.8912, 74.7209),
    "Doda": (33.1500, 75.5500),
    "Ganderbal": (34.2262, 74.7771),
    "Jammu": (32.7266, 74.8570),
    "Kathua": (32.3860, 75.5158),
    "Kishtwar": (33.3100, 75.7700),
    "Kulgam": (33.6400, 75.0200),
    "Kupwara": (34.5290, 74.2540),
    "Poonch": (33.7700, 74.0900),
    "Pulwama": (33.8748, 74.8950),
    "Rajouri": (33.3790, 74.3120),
    "Ramban": (33.2300, 75.2400),
    "Reasi": (33.0800, 74.8300),
    "Samba": (32.5600, 75.1100),
    "Shopian": (33.7166, 74.8310),
    "Srinagar": (34.0837, 74.7973),
    "Udhampur": (32.9160, 75.1419),
    # =========================================================================
    # JHARKHAND (24 districts)
    # =========================================================================
    "Bokaro": (23.6693, 86.1511),
    "Chatra": (24.2100, 84.8700),
    "Deoghar": (24.4854, 86.6938),
    "Dhanbad": (23.7957, 86.4304),
    "Dumka": (24.2636, 87.2494),
    "East Singhbhum": (22.8046, 86.2029),
    "Jamshedpur": (22.8046, 86.2029),
    "Garhwa": (24.1900, 83.8000),
    "Giridih": (24.1853, 86.3014),
    "Godda": (24.8300, 87.2100),
    "Gumla": (23.0400, 84.5400),
    "Hazaribagh": (23.9921, 85.3637),
    "Jamtara": (23.9600, 86.8000),
    "Khunti": (23.0700, 85.2700),
    "Koderma": (24.4700, 85.5900),
    "Latehar": (23.7400, 84.5000),
    "Lohardaga": (23.4400, 84.6800),
    "Pakur": (24.6300, 87.8500),
    "Palamu": (24.0300, 84.0800),
    "Daltonganj": (24.0300, 84.0800),
    "Ramgarh": (23.6300, 85.5100),
    "Ranchi": (23.3441, 85.3096),
    "Sahibganj": (25.2400, 87.6300),
    "Seraikela Kharsawan": (22.7000, 85.8300),
    "Chaibasa": (22.5500, 85.8100),
    "Simdega": (22.6100, 84.5100),
    "West Singhbhum": (22.5500, 85.8100),
    # =========================================================================
    # KARNATAKA (31 districts)
    # =========================================================================
    "Bagalkote": (16.1691, 75.6615),
    "Ballari": (15.1394, 76.9214),
    "Belagavi": (15.8497, 74.4977),
    "Bengaluru Urban": (12.9716, 77.5946),
    "Bengaluru Rural": (13.1986, 77.7066),
    "Chamarajanagar": (11.9264, 76.9418),
    "Chikkaballapur": (13.4355, 77.7315),
    "Chikkamagaluru": (13.3153, 75.7754),
    "Chitradurga": (13.9535, 76.3981),
    "Dakshina Kannada": (12.8745, 74.8423),
    "Mangaluru": (12.8745, 74.8423),
    "Davangere": (14.4644, 75.9218),
    "Dharwad": (15.4589, 75.0078),
    "Gadag": (15.4319, 75.6260),
    "Hassan": (13.0073, 76.0962),
    "Haveri": (14.7951, 75.3990),
    "Kalaburagi": (17.3297, 76.8343),
    "Kodagu": (12.4244, 75.7382),
    "Kolar": (13.1360, 78.1292),
    "Koppal": (15.3547, 76.1546),
    "Mandya": (12.5218, 76.8952),
    "Mysuru": (12.2958, 76.6394),
    "Raichur": (16.2076, 77.3463),
    "Ramanagara": (12.7159, 77.2814),
    "Shivamogga": (13.9299, 75.5681),
    "Tumakuru": (13.3379, 77.1173),
    "Udupi": (13.3409, 74.7421),
    "Uttara Kannada": (14.6800, 74.4700),
    "Bidar": (17.9104, 77.5199),
    "Vijayapura": (16.8302, 75.7100),
    "Yadgir": (16.7700, 77.1380),
    "Vijayanagara": (15.3500, 76.4700),
    "Hubballi": (15.3647, 75.1240),
    # =========================================================================
    # KERALA (14 districts)
    # =========================================================================
    "Thiruvananthapuram": (8.5241, 76.9366),
    "Kollam": (8.8932, 76.6141),
    "Pathanamthitta": (9.2648, 76.7870),
    "Alappuzha": (9.4981, 76.3388),
    "Kottayam": (9.5916, 76.5222),
    "Idukki": (9.8494, 76.9710),
    "Ernakulam": (9.9312, 76.2673),
    "Thrissur": (10.5276, 76.2144),
    "Palakkad": (10.7867, 76.6548),
    "Malappuram": (11.0510, 76.0711),
    "Kozhikode": (11.2588, 75.7804),
    "Wayanad": (11.6854, 76.1320),
    "Kannur": (11.8745, 75.3704),
    "Kasaragod": (12.4996, 74.9869),
    # =========================================================================
    # LADAKH (2 districts)
    # =========================================================================
    "Leh": (34.1526, 77.5771),
    "Kargil": (34.5539, 76.1349),
    # =========================================================================
    # MADHYA PRADESH (55 districts)
    # =========================================================================
    "Agar Malwa": (23.7100, 76.0200),
    "Alirajpur": (22.3100, 74.3500),
    "Anuppur": (23.1100, 81.6900),
    "Ashoknagar": (24.5800, 77.7300),
    "Balaghat": (21.8100, 80.1900),
    "Barwani": (22.0400, 74.9000),
    "Betul": (21.9000, 77.9000),
    "Bhind": (26.5600, 78.7800),
    "Bhopal": (23.2599, 77.4126),
    "Burhanpur": (21.3100, 76.2300),
    "Chhatarpur": (24.9200, 79.5900),
    "Chhindwara": (22.0574, 78.9382),
    "Damoh": (23.8400, 79.4400),
    "Datia": (25.6700, 78.4600),
    "Dewas": (22.9623, 76.0508),
    "Dhar": (22.6000, 75.3000),
    "Dindori": (22.9500, 81.0800),
    "Guna": (24.6500, 77.3100),
    "Gwalior": (26.2183, 78.1828),
    "Harda": (22.3400, 77.0900),
    "Hoshangabad": (22.7500, 77.7200),
    "Narmadapuram": (22.7500, 77.7200),
    "Indore": (22.7196, 75.8577),
    "Jabalpur": (23.1815, 79.9864),
    "Jhabua": (22.7700, 74.5900),
    "Katni": (23.8300, 80.3900),
    "Khandwa": (21.8243, 76.3506),
    "Khargone": (21.8200, 75.6200),
    "Mandla": (22.6000, 80.3800),
    "Mandsaur": (24.0700, 75.0700),
    "Morena": (26.4900, 78.0000),
    "Narsinghpur": (22.9500, 79.1800),
    "Neemuch": (24.4700, 74.8700),
    "Panna": (24.7200, 80.1800),
    "Raisen": (23.3300, 77.7900),
    "Rajgarh": (24.0100, 76.6200),
    "Ratlam": (23.3315, 75.0367),
    "Rewa": (24.5373, 81.3042),
    "Sagar": (23.8388, 78.7378),
    "Satna": (24.5004, 80.8322),
    "Sehore": (23.2000, 77.0900),
    "Seoni": (22.0800, 79.5300),
    "Shahdol": (23.3000, 81.3600),
    "Shajapur": (23.4300, 76.2700),
    "Sheopur": (25.6800, 76.7000),
    "Shivpuri": (25.4200, 77.6500),
    "Sidhi": (24.4100, 81.8700),
    "Singrauli": (24.2000, 82.6700),
    "Tikamgarh": (24.7400, 78.8300),
    "Ujjain": (23.1765, 75.7885),
    "Umaria": (23.5200, 80.8300),
    "Vidisha": (23.5261, 77.8081),
    "Maihar": (24.2600, 80.7500),
    "Niwari": (24.4600, 78.3900),
    # =========================================================================
    # MAHARASHTRA (36 districts)
    # =========================================================================
    "Ahmednagar": (19.0948, 74.7480),
    "Akola": (20.7089, 77.0030),
    "Amravati": (20.9374, 77.7796),
    "Aurangabad": (19.8762, 75.3433),
    "Beed": (18.9890, 75.7601),
    "Bhandara": (21.1668, 79.6504),
    "Buldhana": (20.5293, 76.1807),
    "Chandrapur": (19.9500, 79.2961),
    "Dhule": (20.9042, 74.7749),
    "Gadchiroli": (20.1860, 80.0096),
    "Gondia": (21.4602, 80.1928),
    "Hingoli": (19.7214, 77.1461),
    "Jalgaon": (21.0077, 75.5626),
    "Jalna": (19.8347, 75.8816),
    "Kolhapur": (16.7050, 74.2433),
    "Latur": (18.3968, 76.5604),
    "Mumbai": (19.0760, 72.8777),
    "Mumbai Suburban": (19.1000, 72.8700),
    "Nagpur": (21.1458, 79.0882),
    "Nanded": (19.1383, 77.3210),
    "Nandurbar": (21.3700, 74.2400),
    "Nashik": (19.9975, 73.7898),
    "Osmanabad": (18.1860, 76.0440),
    "Dharashiv": (18.1860, 76.0440),
    "Palghar": (19.6967, 72.7651),
    "Parbhani": (19.2610, 76.7748),
    "Pune": (18.5204, 73.8567),
    "Raigad": (18.5200, 73.0169),
    "Ratnagiri": (16.9944, 73.3001),
    "Sangli": (16.8524, 74.5815),
    "Satara": (17.6805, 74.0183),
    "Sindhudurg": (16.3510, 73.7587),
    "Solapur": (17.6599, 75.9064),
    "Thane": (19.2183, 72.9781),
    "Wardha": (20.7453, 78.6022),
    "Washim": (20.1000, 77.1500),
    "Yavatmal": (20.3885, 78.1204),
    # =========================================================================
    # MANIPUR (16 districts)
    # =========================================================================
    "Bishnupur": (24.6300, 93.7800),
    "Chandel": (24.3200, 93.9800),
    "Churachandpur": (24.3300, 93.6800),
    "Imphal East": (24.8170, 94.0089),
    "Imphal West": (24.8074, 93.9384),
    "Jiribam": (24.7900, 93.1200),
    "Kakching": (24.4976, 93.9764),
    "Kamjong": (25.4000, 94.5000),
    "Kangpokpi": (25.1300, 93.9800),
    "Noney": (25.0000, 93.5000),
    "Pherzawl": (24.4500, 93.3000),
    "Senapati": (25.2700, 94.0200),
    "Tamenglong": (25.0000, 93.5100),
    "Tengnoupal": (24.1600, 94.1300),
    "Thoubal": (24.6300, 94.0000),
    "Ukhrul": (25.1200, 94.3700),
    # =========================================================================
    # MEGHALAYA (12 districts)
    # =========================================================================
    "East Garo Hills": (25.5200, 90.6200),
    "Williamnagar": (25.5200, 90.6200),
    "East Jaintia Hills": (25.3600, 92.3600),
    "Khliehriat": (25.3600, 92.3600),
    "East Khasi Hills": (25.5788, 91.8933),
    "Shillong": (25.5788, 91.8933),
    "North Garo Hills": (25.8800, 90.6500),
    "Resubelpara": (25.8800, 90.6500),
    "Ri Bhoi": (25.8600, 91.8400),
    "Nongpoh": (25.8600, 91.8400),
    "South Garo Hills": (25.2100, 90.6300),
    "Baghmara": (25.2100, 90.6300),
    "South West Garo Hills": (25.2600, 90.3200),
    "South West Khasi Hills": (25.3800, 91.2700),
    "West Garo Hills": (25.5200, 90.2200),
    "Tura": (25.5200, 90.2200),
    "West Jaintia Hills": (25.4500, 92.2000),
    "Jowai": (25.4500, 92.2000),
    "West Khasi Hills": (25.4900, 91.2700),
    "Nongstoin": (25.4900, 91.2700),
    # =========================================================================
    # MIZORAM (11 districts)
    # =========================================================================
    "Aizawl": (23.7271, 92.7176),
    "Champhai": (23.4600, 93.3300),
    "Hnahthial": (22.5600, 92.9600),
    "Khawzawl": (23.3500, 93.2000),
    "Kolasib": (24.2200, 92.6800),
    "Lawngtlai": (22.5300, 92.8900),
    "Lunglei": (22.8800, 92.7300),
    "Mamit": (23.9200, 92.4900),
    "Saiha": (22.4900, 92.9800),
    "Saitual": (23.8500, 92.9200),
    "Serchhip": (23.3100, 92.8500),
    # =========================================================================
    # NAGALAND (16 districts)
    # =========================================================================
    "Chumoukedima": (25.8700, 93.7200),
    "Dimapur": (25.9000, 93.7300),
    "Kiphire": (25.8700, 95.1200),
    "Kohima": (25.6586, 94.1086),
    "Longleng": (26.2600, 94.8700),
    "Mokokchung": (26.3200, 94.5200),
    "Mon": (26.7100, 95.0400),
    "Niuland": (25.8000, 94.3000),
    "Noklak": (26.4500, 95.1000),
    "Peren": (25.5200, 93.7300),
    "Phek": (25.6700, 94.4800),
    "Shamator": (26.1500, 95.0500),
    "Tseminyu": (25.8200, 94.3200),
    "Tuensang": (26.2700, 94.8300),
    "Wokha": (26.1000, 94.2700),
    "Zunheboto": (26.0100, 94.5200),
    # =========================================================================
    # ODISHA (30 districts)
    # =========================================================================
    "Angul": (20.8408, 85.0988),
    "Balangir": (20.7200, 83.4900),
    "Balasore": (21.4934, 86.9337),
    "Bargarh": (21.3300, 83.6200),
    "Bhadrak": (21.0549, 86.4953),
    "Bhubaneswar": (20.2961, 85.8245),
    "Boudh": (20.8400, 84.3200),
    "Cuttack": (20.4625, 85.8830),
    "Deogarh": (21.5300, 84.7300),
    "Dhenkanal": (20.6700, 85.5900),
    "Gajapati": (19.2200, 84.0700),
    "Ganjam": (19.3800, 84.9300),
    "Berhampur": (19.3150, 84.7941),
    "Jagatsinghpur": (20.2600, 86.1700),
    "Jajpur": (20.8500, 86.3400),
    "Jharsuguda": (21.8554, 84.0063),
    "Kalahandi": (19.9000, 83.1700),
    "Kandhamal": (20.3100, 84.2500),
    "Kendrapara": (20.5000, 86.4200),
    "Keonjhar": (21.6300, 85.5800),
    "Khordha": (20.1827, 85.6173),
    "Koraput": (18.8135, 82.7123),
    "Malkangiri": (18.3500, 81.8800),
    "Mayurbhanj": (21.9400, 86.7300),
    "Baripada": (21.9326, 86.7285),
    "Nabarangpur": (19.2200, 82.5500),
    "Nayagarh": (20.1300, 85.1000),
    "Nuapada": (20.8200, 82.5400),
    "Puri": (19.8135, 85.8312),
    "Rayagada": (19.1700, 83.4200),
    "Rourkela": (22.2604, 84.8536),
    "Sambalpur": (21.4669, 83.9812),
    "Subarnapur": (20.8400, 83.8800),
    "Sundargarh": (22.1200, 84.0400),
    # =========================================================================
    # PUNJAB (23 districts)
    # =========================================================================
    "Amritsar": (31.6340, 74.8723),
    "Barnala": (30.3819, 75.5469),
    "Bathinda": (30.2110, 74.9455),
    "Faridkot": (30.6755, 74.7573),
    "Fatehgarh Sahib": (30.6400, 76.3900),
    "Fazilka": (30.4036, 74.0286),
    "Firozpur": (30.9289, 74.6131),
    "Gurdaspur": (32.0353, 75.4019),
    "Hoshiarpur": (31.5143, 75.9115),
    "Jalandhar": (31.3260, 75.5762),
    "Kapurthala": (31.3808, 75.3782),
    "Ludhiana": (30.9010, 75.8573),
    "Malerkotla": (30.5200, 75.8800),
    "Mansa": (29.9996, 75.3859),
    "Moga": (30.8163, 75.1718),
    "Mohali": (30.7046, 76.7179),
    "Muktsar": (30.4735, 74.5137),
    "Nawanshahr": (31.1100, 76.1200),
    "Pathankot": (32.2643, 75.6421),
    "Patiala": (30.3398, 76.3869),
    "Ropar": (30.9700, 76.5300),
    "Rupnagar": (30.9700, 76.5300),
    "Sangrur": (30.2439, 75.8412),
    "Tarn Taran": (31.4500, 74.9300),
    # =========================================================================
    # RAJASTHAN (33 districts)
    # =========================================================================
    "Ajmer": (26.4499, 74.6399),
    "Alwar": (27.5530, 76.6346),
    "Banswara": (23.5445, 74.4436),
    "Baran": (25.1012, 76.5132),
    "Barmer": (25.7532, 71.3927),
    "Bharatpur": (27.2152, 77.5030),
    "Bhilwara": (25.3407, 74.6313),
    "Bikaner": (28.0229, 73.3119),
    "Bundi": (25.4305, 75.6376),
    "Chittorgarh": (24.8887, 74.6269),
    "Churu": (28.2951, 74.9680),
    "Dausa": (26.8843, 76.3345),
    "Dholpur": (26.7020, 77.8970),
    "Dungarpur": (23.8435, 73.7474),
    "Sri Ganganagar": (29.9038, 73.8772),
    "Hanumangarh": (29.5800, 74.3292),
    "Jaipur": (26.9124, 75.7873),
    "Jaisalmer": (26.9157, 70.9083),
    "Jalore": (25.3459, 72.6148),
    "Jhalawar": (24.5964, 76.1601),
    "Jhunjhunu": (28.1320, 75.3985),
    "Jodhpur": (26.2389, 73.0243),
    "Karauli": (26.4936, 77.0237),
    "Kota": (25.2138, 75.8648),
    "Nagaur": (27.2024, 73.7390),
    "Pali": (25.7711, 73.3234),
    "Pratapgarh Raj": (24.0318, 74.7800),
    "Rajsamand": (25.0700, 73.8800),
    "Sawai Madhopur": (26.0200, 76.3500),
    "Sikar": (27.6094, 75.1399),
    "Sirohi": (24.8800, 72.8600),
    "Tonk": (26.1665, 75.7885),
    "Udaipur": (24.5854, 73.7125),
    # =========================================================================
    # SIKKIM (6 districts)
    # =========================================================================
    "East Sikkim": (27.3389, 88.6065),
    "Gangtok": (27.3389, 88.6065),
    "West Sikkim": (27.3300, 88.2200),
    "Gyalshing": (27.2800, 88.2600),
    "North Sikkim": (27.7000, 88.5100),
    "Mangan": (27.5000, 88.5200),
    "South Sikkim": (27.1500, 88.3200),
    "Namchi": (27.1667, 88.3500),
    "Pakyong": (27.2300, 88.7200),
    "Soreng": (27.1700, 88.1600),
    "Rangpo": (27.1753, 88.5312),
    "Singtam": (27.2344, 88.5056),
    "Jorethang": (27.1000, 88.3100),
    # =========================================================================
    # TAMIL NADU (38 districts)
    # =========================================================================
    "Ariyalur": (11.1400, 79.0780),
    "Chengalpattu": (12.6819, 79.9888),
    "Chengalpet": (12.6819, 79.9888),
    "Chennai": (13.0827, 80.2707),
    "Coimbatore": (11.0168, 76.9558),
    "Cuddalore": (11.7480, 79.7714),
    "Dharmapuri": (12.1211, 78.1582),
    "Dindigul": (10.3624, 77.9695),
    "Erode": (11.3410, 77.7172),
    "Kallakurichi": (11.7380, 78.9550),
    "Kancheepuram": (12.8342, 79.7036),
    "Kanyakumari": (8.0883, 77.5385),
    "Karur": (10.9601, 78.0766),
    "Krishnagiri": (12.5186, 78.2137),
    "Madurai": (9.9252, 78.1198),
    "Mayiladuthurai": (11.1020, 79.6530),
    "Nagapattinam": (10.7672, 79.8449),
    "Namakkal": (11.2189, 78.1674),
    "Nilgiris": (11.4916, 76.7337),
    "Perambalur": (11.2333, 78.8833),
    "Pudukkottai": (10.3833, 78.8001),
    "Ramanathapuram": (9.3639, 78.8395),
    "Ranipet": (12.9224, 79.3333),
    "Salem": (11.6643, 78.1460),
    "Sivaganga": (10.0000, 78.4833),
    "Tenkasi": (8.9600, 77.3100),
    "Thanjavur": (10.7870, 79.1378),
    "Theni": (10.0104, 77.4768),
    "Thoothukudi": (8.7642, 78.1348),
    "Tiruchirappalli": (10.7905, 78.7047),
    "Tirunelveli": (8.7139, 77.7567),
    "Tirupathur": (12.4950, 78.5714),
    "Tiruppur": (11.1085, 77.3411),
    "Tiruvallur": (13.1431, 79.9085),
    "Tiruvannamalai": (12.2253, 79.0747),
    "Tiruvarur": (10.7723, 79.6361),
    "Vellore": (12.9165, 79.1325),
    "Villupuram": (11.9401, 79.4861),
    "Virudhunagar": (9.5810, 77.9624),
    # =========================================================================
    # TELANGANA (33 districts)
    # =========================================================================
    "Adilabad": (19.6641, 78.5320),
    "Bhadradri Kothagudem": (17.5500, 80.6200),
    "Hyderabad": (17.3850, 78.4867),
    "Jagtial": (18.7940, 78.9150),
    "Jangaon": (17.7200, 79.1500),
    "Jayashankar Bhupalapally": (18.4300, 79.9800),
    "Jogulamba Gadwal": (16.2300, 77.8100),
    "Kamareddy": (18.3200, 78.3400),
    "Karimnagar": (18.4386, 79.1288),
    "Khammam": (17.2473, 80.1514),
    "Kumuram Bheem Asifabad": (19.3600, 79.2800),
    "Mahabubabad": (17.5800, 80.0000),
    "Mahbubnagar": (16.7488, 77.9855),
    "Mancherial": (18.8700, 79.4400),
    "Medak": (18.0479, 78.2597),
    "Medchal Malkajgiri": (17.5400, 78.5400),
    "Mulugu": (18.1900, 80.0000),
    "Nagarkurnool": (16.4800, 78.3100),
    "Nalgonda": (17.0583, 79.2671),
    "Narayanpet": (16.7500, 77.5000),
    "Nirmal": (19.1000, 78.3400),
    "Nizamabad": (18.6725, 78.0940),
    "Peddapalli": (18.6200, 79.3800),
    "Rajanna Sircilla": (18.3900, 78.8300),
    "Rangareddy": (17.2543, 78.3907),
    "Sangareddy": (17.6200, 78.0900),
    "Siddipet": (18.1000, 78.8500),
    "Suryapet": (17.1400, 79.6200),
    "Vikarabad": (17.3400, 77.9100),
    "Wanaparthy": (16.3600, 78.0600),
    "Warangal": (17.9784, 79.5941),
    "Yadadri Bhuvanagiri": (17.5900, 78.9400),
    "Ramagundam": (18.7557, 79.4740),
    # =========================================================================
    # TRIPURA (8 districts)
    # =========================================================================
    "Agartala": (23.8315, 91.2868),
    "West Tripura": (23.8315, 91.2868),
    "Dharmanagar": (24.3770, 92.1660),
    "North Tripura": (24.3770, 92.1660),
    "Kailashahar": (24.3300, 92.0100),
    "Unakoti": (24.3300, 92.0100),
    "Udaipur Tripura": (23.5300, 91.4900),
    "Gomati": (23.5300, 91.4900),
    "Khowai": (24.0700, 91.6100),
    "Bishalgarh": (23.4300, 91.3100),
    "Sepahijala": (23.4300, 91.3100),
    "Belonia": (23.2500, 91.4500),
    "South Tripura": (23.2500, 91.4500),
    "Dhalai": (23.8400, 91.9800),
    "Ambassa": (23.9200, 91.8500),
    "Sabroom": (23.0100, 91.7100),
    # =========================================================================
    # UTTAR PRADESH (75 districts)
    # =========================================================================
    "Agra": (27.1767, 78.0081),
    "Aligarh": (27.8974, 78.0880),
    "Allahabad": (25.4358, 81.8463),
    "Prayagraj": (25.4358, 81.8463),
    "Ambedkar Nagar": (26.4470, 82.5396),
    "Amethi": (26.1536, 81.8120),
    "Amroha": (28.9044, 78.4679),
    "Auraiya": (26.4657, 79.5072),
    "Azamgarh": (26.0735, 83.1854),
    "Ayodhya": (26.7922, 82.1998),
    "Baghpat": (28.9454, 77.2211),
    "Bahraich": (27.5745, 81.5957),
    "Ballia": (25.7612, 84.1483),
    "Balrampur": (27.4304, 82.1803),
    "Banda": (25.4756, 80.3365),
    "Barabanki": (26.9322, 81.1846),
    "Bareilly": (28.3670, 79.4304),
    "Basti": (26.7929, 82.7282),
    "Bhadohi": (25.4000, 82.5700),
    "Bijnor": (29.3725, 78.1365),
    "Budaun": (28.0500, 79.1200),
    "Bulandshahr": (28.4069, 77.8498),
    "Chandauli": (25.2700, 83.2600),
    "Chitrakoot": (25.2000, 80.8500),
    "Deoria": (26.5024, 83.7791),
    "Etah": (27.5700, 78.6700),
    "Etawah": (26.7760, 79.0437),
    "Farrukhabad": (27.3900, 79.5800),
    "Fatehpur": (25.9300, 80.8100),
    "Firozabad": (27.1591, 78.3957),
    "Gautam Buddha Nagar": (28.5355, 77.3910),
    "Noida": (28.5355, 77.3910),
    "Ghaziabad": (28.6692, 77.4538),
    "Ghazipur": (25.5878, 83.5789),
    "Gonda": (27.1361, 81.9619),
    "Gorakhpur": (26.7606, 83.3732),
    "Hamirpur Up": (25.9500, 80.1500),
    "Hapur": (28.7300, 77.7800),
    "Hardoi": (27.3950, 80.1313),
    "Hathras": (27.5937, 78.0548),
    "Jalaun": (26.1500, 79.3400),
    "Jaunpur": (25.7464, 82.6837),
    "Jhansi": (25.4484, 78.5685),
    "Kannauj": (27.0545, 79.9218),
    "Kanpur": (26.4499, 80.3319),
    "Kanpur Dehat": (26.4000, 79.9500),
    "Kasganj": (27.8100, 78.6500),
    "Kaushambi": (25.5300, 81.3800),
    "Kushinagar": (26.7400, 83.8900),
    "Lakhimpur Kheri": (27.9500, 80.7900),
    "Lalitpur": (24.6900, 78.4100),
    "Lucknow": (26.8467, 80.9462),
    "Maharajganj": (27.1200, 83.5600),
    "Mahoba": (25.2900, 79.8700),
    "Mainpuri": (27.2300, 79.0200),
    "Mathura": (27.4924, 77.6737),
    "Mau": (25.9400, 83.5600),
    "Meerut": (28.9845, 77.7064),
    "Mirzapur": (25.1500, 82.5600),
    "Moradabad": (28.8386, 78.7733),
    "Muzaffarnagar": (29.4727, 77.7085),
    "Pilibhit": (28.6400, 79.8100),
    "Pratapgarh Up": (25.8953, 81.9441),
    "Raebareli": (26.2300, 81.2300),
    "Rampur": (28.7930, 79.0250),
    "Saharanpur": (29.9680, 77.5510),
    "Sambhal": (28.5800, 78.5700),
    "Sant Kabir Nagar": (26.7900, 83.0400),
    "Shahjahanpur": (27.8800, 79.9100),
    "Shamli": (29.4500, 77.3100),
    "Shravasti": (27.5100, 81.7600),
    "Siddharthnagar": (27.2200, 83.0800),
    "Sitapur": (27.5620, 80.6822),
    "Sonbhadra": (24.6900, 83.0600),
    "Sultanpur": (26.2648, 82.0713),
    "Unnao": (26.5500, 80.4900),
    # =========================================================================
    # UTTARAKHAND (13 districts)
    # =========================================================================
    "Almora": (29.5971, 79.6591),
    "Bageshwar": (29.8400, 79.7700),
    "Chamoli": (30.4000, 79.3300),
    "Gopeshwar": (30.4063, 79.3186),
    "Champawat": (29.3400, 80.0900),
    "Dehradun": (30.3165, 78.0322),
    "Haridwar": (29.9457, 78.1642),
    "Rishikesh": (30.0869, 78.2676),
    "Nainital": (29.3803, 79.4636),
    "Haldwani": (29.2183, 79.5130),
    "Pauri Garhwal": (30.1500, 78.7800),
    "Pithoragarh": (29.5829, 80.2182),
    "Rudraprayag": (30.2840, 78.9830),
    "Tehri Garhwal": (30.3900, 78.4300),
    "Udham Singh Nagar": (28.9747, 79.3960),
    "Rudrapur": (28.9747, 79.3960),
    "Kashipur": (29.2104, 78.9618),
    "Uttarkashi": (30.7300, 78.4400),
    "Roorkee": (29.8543, 77.8880),
    # =========================================================================
    # WEST BENGAL (23 districts)
    # =========================================================================
    "Alipurduar": (26.4900, 89.5300),
    "Bankura": (23.2500, 87.0700),
    "Bardhaman": (23.2332, 87.8615),
    "Birbhum": (23.8600, 87.6200),
    "Cooch Behar": (26.3300, 89.4500),
    "Dakshin Dinajpur": (25.2200, 88.7600),
    "Darjeeling": (27.0410, 88.2627),
    "Durgapur": (23.5204, 87.3119),
    "Hooghly": (22.9000, 88.3900),
    "Howrah": (22.5958, 88.2636),
    "Jalpaiguri": (26.5169, 88.7295),
    "Jhargram": (22.4500, 86.9800),
    "Kalimpong": (27.0600, 88.4700),
    "Kharagpur": (22.3460, 87.2320),
    "Kolkata": (22.5726, 88.3639),
    "Malda": (25.0108, 88.1411),
    "Midnapore": (22.4249, 87.3194),
    "Paschim Medinipur": (22.4249, 87.3194),
    "Purba Medinipur": (22.2600, 87.9200),
    "Murshidabad": (24.1745, 88.2700),
    "Nadia": (23.4710, 88.5565),
    "Krishnanagar": (23.4000, 88.5000),
    "North 24 Parganas": (22.6173, 88.4204),
    "South 24 Parganas": (22.1352, 88.4015),
    "Purulia": (23.3300, 86.3600),
    "Siliguri": (26.7271, 88.3953),
    "Uttar Dinajpur": (25.6200, 88.1200),
    "Raiganj": (25.6200, 88.1200),
    "Baharampur": (24.0962, 88.2534),
    "Asansol": (23.6830, 86.9585),
    # =========================================================================
    # UNION TERRITORIES
    # =========================================================================
    # Delhi
    "Delhi": (28.6139, 77.2090),
    "New Delhi": (28.6139, 77.2090),
    "North Delhi": (28.6139, 77.2090),
    "South Delhi": (28.5244, 77.2090),
    "East Delhi": (28.6280, 77.2950),
    "West Delhi": (28.6519, 77.1025),
    "Central Delhi": (28.6489, 77.2167),
    "North East Delhi": (28.6900, 77.2700),
    "North West Delhi": (28.7400, 77.0700),
    "South East Delhi": (28.5300, 77.2900),
    "South West Delhi": (28.5400, 77.0600),
    "Shahdara": (28.6700, 77.2900),
    # Chandigarh
    "Chandigarh": (30.7333, 76.7794),
    # Puducherry
    "Puducherry": (11.9416, 79.8083),
    "Pondicherry": (11.9416, 79.8083),
    "Karaikal": (10.9254, 79.8380),
    "Mahe": (11.7036, 75.5353),
    "Yanam": (16.7307, 82.2138),
    # Andaman & Nicobar
    "South Andaman": (11.6234, 92.7265),
    "Port Blair": (11.6234, 92.7265),
    "North And Middle Andaman": (12.7000, 92.9000),
    "Nicobar": (7.1500, 93.8000),
    "Car Nicobar": (9.1700, 92.7700),
    # Lakshadweep
    "Lakshadweep": (10.5667, 72.6417),
    "Kavaratti": (10.5626, 72.6369),
    # Dadra and Nagar Haveli and Daman and Diu
    "Dadra And Nagar Haveli": (20.2700, 73.0200),
    "Silvassa": (20.2766, 73.0169),
    "Daman": (20.3974, 72.8328),
    "Diu": (20.7144, 70.9874),
}

# =============================================================================
# CORE LOGIC FUNCTIONS
# =============================================================================


def haversine_distance(lat1: float, lon1: float, lat2: float, lon2: float) -> float:
    """Calculate the great-circle distance between two points (km)."""
    R = 6371.0
    lat1_rad = math.radians(lat1)
    lat2_rad = math.radians(lat2)
    delta_lat = math.radians(lat2 - lat1)
    delta_lon = math.radians(lon2 - lon1)

    a = (math.sin(delta_lat / 2) ** 2 +
         math.cos(lat1_rad) * math.cos(lat2_rad) * math.sin(delta_lon / 2) ** 2)
    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1 - a))
    return R * c


# Simple in-process cache: (lat1,lon1,lat2,lon2) → road_km
_road_distance_cache: Dict[Tuple, float] = {}

# Terrain-based fallback multipliers by state pair (approximate)
# Used when OSRM is unavailable.
# Kerala is intentionally excluded from _HILLY_STATES: most Kerala transport runs
# along the flat NH544 coastal corridor (Thrissur, Ernakulam, Kottayam, etc.).
# Using the hilly multiplier (1.6) overestimates distances significantly for these routes.
_HILLY_STATES = {"Himachal Pradesh", "Uttarakhand", "Jammu and Kashmir",
                 "Arunachal Pradesh", "Sikkim", "Meghalaya", "Nagaland", "Manipur",
                 "Mizoram", "Tripura", "Assam", "Goa"}

# Kerala has mixed terrain (flat coast + inland Ghats). Use an intermediate multiplier.
_SEMI_HILLY_STATES = {"Kerala", "Tamil Nadu", "Karnataka", "Andhra Pradesh",
                      "Telangana", "Maharashtra", "Odisha", "West Bengal"}


def _fallback_multiplier(source_state: str = "", dest_state: str = "") -> float:
    """Return a terrain-aware Haversine→road multiplier when OSRM is unavailable."""
    hilly_src = source_state in _HILLY_STATES
    hilly_dst = dest_state in _HILLY_STATES
    semi_src = source_state in _SEMI_HILLY_STATES
    semi_dst = dest_state in _SEMI_HILLY_STATES
    if hilly_src and hilly_dst:
        return 1.6   # both fully hilly (e.g. HP→Uttarakhand)
    if hilly_src or hilly_dst:
        return 1.45  # one end fully hilly
    if semi_src or semi_dst:
        return 1.30  # semi-hilly (e.g. Kerala coast, peninsular states)
    return 1.25      # flat terrain (plains)


def get_road_distance(
    lat1: float, lon1: float,
    lat2: float, lon2: float,
    source_state: str = "",
    dest_state: str = "",
) -> float:
    """
    Return estimated road distance (km) using Haversine × terrain multiplier.
    Fully local — no external API calls — so the transport compare endpoint
    stays fast even with 40 candidate mandis.
    Results are cached in-process.
    """
    cache_key = (round(lat1, 4), round(lon1, 4),
                 round(lat2, 4), round(lon2, 4))
    if cache_key in _road_distance_cache:
        return _road_distance_cache[cache_key]

    haversine_km = haversine_distance(lat1, lon1, lat2, lon2)
    multiplier = _fallback_multiplier(source_state, dest_state)
    road_km = haversine_km * multiplier
    _road_distance_cache[cache_key] = road_km
    return road_km


def select_vehicle(quantity_kg: float) -> VehicleType:
    """Select appropriate vehicle based on quantity."""
    if quantity_kg <= VEHICLES[VehicleType.TEMPO]["capacity_kg"]:
        return VehicleType.TEMPO
    elif quantity_kg <= VEHICLES[VehicleType.TRUCK_SMALL]["capacity_kg"]:
        return VehicleType.TRUCK_SMALL
    else:
        return VehicleType.TRUCK_LARGE


def calculate_transport_cost(distance_km: float, vehicle_type: VehicleType) -> float:
    """Calculate basic transport cost for one trip (distance * rate)."""
    cost_per_km = VEHICLES[vehicle_type]["cost_per_km"]
    return distance_km * cost_per_km


def calculate_net_profit(
    price_per_kg: float,
    quantity_kg: float,
    distance_km: float,
    vehicle_type: VehicleType
) -> Dict[str, float]:
    """
    Calculate detailed cost breakdown and net profit.

    Includes: freight, toll, loading, unloading, mandi fees, commission,
    weighbridge, parking, and documentation charges.
    """
    gross_revenue = price_per_kg * quantity_kg

    # Calculate trips
    capacity = VEHICLES[vehicle_type]["capacity_kg"]
    trips = math.ceil(quantity_kg / capacity)

    # 1. Freight Cost (one-way: driver picks up return load independently)
    one_way_freight = calculate_transport_cost(distance_km, vehicle_type)
    total_transport_cost = one_way_freight * trips

    # 2. Toll Charges (one-way only)
    toll_plazas = max(1, round(distance_km / TOLL_PLAZA_SPACING_KM))
    toll_cost_per_trip = toll_plazas * VEHICLES[vehicle_type]["toll_per_plaza"]
    total_toll_cost = toll_cost_per_trip * trips

    # 3. Loading & Unloading
    loading_cost = quantity_kg * LOADING_COST_PER_KG
    unloading_cost = quantity_kg * UNLOADING_COST_PER_KG

    # 4. Mandi Fees & Commission
    mandi_fee = gross_revenue * MANDI_FEE_RATE
    commission = gross_revenue * COMMISSION_RATE

    # 5. Additional Charges (per trip)
    additional_cost = (WEIGHBRIDGE_FEE + PARKING_FEE +
                       DOCUMENTATION_FEE) * trips

    # Total Cost
    total_cost = (total_transport_cost + total_toll_cost + loading_cost +
                  unloading_cost + mandi_fee + commission + additional_cost)

    # Net Profit
    net_profit = gross_revenue - total_cost
    profit_per_kg = net_profit / quantity_kg if quantity_kg > 0 else 0
    roi_percentage = (net_profit / total_cost * 100) if total_cost > 0 else 0

    return {
        "gross_revenue": gross_revenue,
        "transport_cost": total_transport_cost,
        "toll_cost": total_toll_cost,
        "loading_cost": loading_cost,
        "unloading_cost": unloading_cost,
        "mandi_fee": mandi_fee,
        "commission": commission,
        "additional_cost": additional_cost,
        "total_cost": total_cost,
        "net_profit": net_profit,
        "profit_per_kg": profit_per_kg,
        "roi_percentage": roi_percentage,
        "trips": trips,
        "toll_plazas": toll_plazas
    }

# =============================================================================
# DATA ACCESS & INTEGRATION
# =============================================================================


def get_mandis_for_commodity(commodity_id: str, db: Session, limit: int = 100) -> List[Dict[str, Any]]:
    """
    Fetch mandis that have recent price data for a commodity.

    Uses a date-bounded CTE for performance on the 25M-row price_history table.
    Prices are converted from per-quintal (DB) to per-kg for calculations.
    """
    if not db:
        return []

    from sqlalchemy import text

    # Get reference date (latest data date for this commodity)
    max_date = db.execute(
        text("SELECT MAX(price_date) FROM price_history WHERE commodity_id = CAST(:cid AS UUID)"),
        {"cid": str(commodity_id)}
    ).scalar()

    if not max_date:
        return []

    params = {
        "commodity_id": str(commodity_id),
        "max_date": str(max_date),
        "limit": limit,
    }

    # CTE: latest price per mandi_name within last 30 days
    # Then LEFT JOIN mandis to get coordinates and location info
    query = text("""
        WITH recent_prices AS (
            SELECT DISTINCT ON (ph.mandi_name)
                ph.mandi_name,
                ph.mandi_id,
                ph.modal_price,
                ph.price_date
            FROM price_history ph
            WHERE ph.commodity_id = CAST(:commodity_id AS UUID)
              AND ph.price_date >= (CAST(:max_date AS date) - INTERVAL '30 days')
              AND ph.modal_price > 0
            ORDER BY ph.mandi_name, ph.price_date DESC
        )
        SELECT
            rp.mandi_name,
            rp.modal_price,
            rp.price_date,
            m.id as mandi_id,
            m.state,
            m.district,
            m.latitude,
            m.longitude
        FROM recent_prices rp
        LEFT JOIN mandis m ON m.id = rp.mandi_id
        ORDER BY rp.modal_price DESC
        LIMIT :limit
    """)

    rows = db.execute(query, params).fetchall()

    results = []
    for row in rows:
        # modal_price is in ₹ per quintal (100 kg) - convert to per-kg
        price_per_quintal = float(row.modal_price)
        price_per_kg = price_per_quintal / 100.0

        lat = float(row.latitude) if row.latitude else None
        lon = float(row.longitude) if row.longitude else None

        # Fallback: use district coordinates if mandi has no geocode
        if not (lat and lon):
            district = (row.district or "").strip().title()
            if district in DISTRICT_COORDINATES:
                lat, lon = DISTRICT_COORDINATES[district]

        results.append({
            "id": row.mandi_id,
            "name": row.mandi_name,
            "state": row.state,
            "district": row.district,
            "price_per_kg": price_per_kg,
            "price_per_quintal": price_per_quintal,
            "latitude": lat,
            "longitude": lon
        })
    return results


def get_source_coordinates(
    request: TransportCompareRequest,
    db: Session = None,
) -> tuple[float, float] | None:
    """
    Resolve the farmer's source location to (lat, lon).

    Priority:
    1. Explicit coordinates from request
    2. Hardcoded DISTRICT_COORDINATES lookup
    3. DB lookup: average coordinates of mandis in that district
    4. DB lookup: average coordinates of mandis in that state
    """
    if request.source_latitude and request.source_longitude:
        return (request.source_latitude, request.source_longitude)

    district = request.source_district.strip().title()
    if district in DISTRICT_COORDINATES:
        return DISTRICT_COORDINATES[district]

    # DB fallback: find coordinates from mandis in the same district
    if db:
        from sqlalchemy import text

        row = db.execute(
            text("""
                SELECT AVG(latitude) as lat, AVG(longitude) as lon
                FROM mandis
                WHERE district ILIKE :district
                  AND latitude IS NOT NULL
                  AND longitude IS NOT NULL
                  AND is_active = true
            """),
            {"district": f"%{district}%"},
        ).first()
        if row and row.lat and row.lon:
            return (float(row.lat), float(row.lon))

        # State-level fallback
        if request.source_state:
            state = request.source_state.strip()
            row = db.execute(
                text("""
                    SELECT AVG(latitude) as lat, AVG(longitude) as lon
                    FROM mandis
                    WHERE state ILIKE :state
                      AND latitude IS NOT NULL
                      AND longitude IS NOT NULL
                      AND is_active = true
                """),
                {"state": f"%{state}%"},
            ).first()
            if row and row.lat and row.lon:
                return (float(row.lat), float(row.lon))

    return None


def compare_mandis(request: TransportCompareRequest, db: Session = None) -> List[MandiComparison]:
    """
    Compare transport options to find the most profitable mandi.

    1. Resolves commodity name → ID
    2. Fetches mandis with recent prices for that commodity
    3. Resolves source coordinates
    4. Calculates distance, costs, and net profit for each mandi
    5. Returns sorted by net profit (highest first), respecting request.limit
    """
    if not db:
        raise ValueError("Database session required")

    # Resolve commodity name to ID
    from app.models import Commodity
    commodity = db.query(Commodity).filter(
        Commodity.name.ilike(request.commodity)
    ).first()

    if not commodity:
        raise ValueError(f"Commodity '{request.commodity}' not found")

    # Fetch mandis with recent price data (more than limit, we'll trim later)
    raw_mandis = get_mandis_for_commodity(
        str(commodity.id), db, limit=200
    )

    # Resolve source coordinates
    coords = get_source_coordinates(request, db)
    if coords is None:
        raise ValueError(
            f"Could not determine coordinates for district '{request.source_district}'. "
            f"Please provide source_latitude and source_longitude."
        )

    source_lat, source_lon = coords
    vehicle_type = select_vehicle(request.quantity_kg)
    capacity = VEHICLES[vehicle_type]["capacity_kg"]
    trips = math.ceil(request.quantity_kg / capacity)

    comparisons: list[MandiComparison] = []

    # Pre-filter and sort by haversine before calling OSRM
    # This avoids unnecessary routing API calls for distant mandis
    candidates = []
    for m in raw_mandis:
        if not m.get("latitude") or not m.get("longitude") or m.get("price_per_kg") is None:
            continue
        straight_km = haversine_distance(
            source_lat, source_lon, m["latitude"], m["longitude"])
        # Pre-filter: if max_distance set, skip mandis beyond it even in straight line
        if request.max_distance_km and straight_km > request.max_distance_km:
            continue
        candidates.append((straight_km, m))

    # Sort by straight-line distance and limit OSRM calls to nearest 40
    candidates.sort(key=lambda x: x[0])
    max_osrm_calls = 40
    candidates = candidates[:max(max_osrm_calls, request.limit * 4)]

    for straight_km, m in candidates:
        # Get accurate road distance (OSRM with cache + terrain fallback)
        dest_state = m.get("state") or ""
        road_dist = get_road_distance(
            source_lat, source_lon,
            m["latitude"], m["longitude"],
            source_state=request.source_state or "",
            dest_state=dest_state,
        )

        if request.max_distance_km and road_dist > request.max_distance_km:
            continue

        profit_data = calculate_net_profit(
            price_per_kg=m["price_per_kg"],
            quantity_kg=request.quantity_kg,
            distance_km=road_dist,
            vehicle_type=vehicle_type
        )

        costs = CostBreakdown(
            transport_cost=round(profit_data["transport_cost"], 2),
            toll_cost=round(profit_data["toll_cost"], 2),
            loading_cost=round(profit_data["loading_cost"], 2),
            unloading_cost=round(profit_data["unloading_cost"], 2),
            mandi_fee=round(profit_data["mandi_fee"], 2),
            commission=round(profit_data["commission"], 2),
            additional_cost=round(profit_data["additional_cost"], 2),
            total_cost=round(profit_data["total_cost"], 2),
        )

        comp = MandiComparison(
            mandi_id=m.get("id"),
            mandi_name=m["name"],
            state=m.get("state") or "Unknown",
            district=m.get("district") or "Unknown",
            distance_km=round(road_dist, 1),
            price_per_kg=round(m["price_per_kg"], 2),
            gross_revenue=round(profit_data["gross_revenue"], 2),
            costs=costs,
            net_profit=round(profit_data["net_profit"], 2),
            profit_per_kg=round(profit_data["profit_per_kg"], 2),
            roi_percentage=round(profit_data["roi_percentage"], 1),
            vehicle_type=vehicle_type,
            vehicle_capacity_kg=capacity,
            trips_required=trips,
            recommendation="recommended" if profit_data["net_profit"] > 0 else "not_recommended",
        )
        comparisons.append(comp)

    comparisons.sort(key=lambda x: x.net_profit, reverse=True)

    # Respect the limit from request
    return comparisons[: request.limit]
