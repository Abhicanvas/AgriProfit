from groq import Groq
import os, json, re
from pathlib import Path

client = Groq(api_key=os.environ["GROQ_API_KEY"])

files = []

for path in Path(".").rglob("*"):
    if (
        path.suffix in [".py", ".js", ".ts"]
        and ".github" not in str(path)
        and "ai/" not in str(path)
    ):
        try:
            files.append(f"\nFILE: {path}\n{path.read_text()}")
        except:
            pass

prompt = f"""
You are a senior engineer doing a STRICT code review.

ABSOLUTE RULES:
- DO NOT explain anything
- DO NOT add markdown
- DO NOT add commentary
- OUTPUT VALID JSON ONLY
- IF NO ISSUES, OUTPUT {{ "gaps": [] }}

Schema (MUST MATCH EXACTLY):
{{
  "gaps": [
    {{
      "file": "path",
      "line": number,
      "severity": "critical|major|minor",
      "message": "what is missing or wrong"
    }}
  ]
}}

Code:
{''.join(files)}
"""

response = client.chat.completions.create(
    model="llama-3.1-8b-instant",
    messages=[{"role": "user", "content": prompt}],
    temperature=0
)

raw = response.choices[0].message.content.strip()

# --- HARDENING: extract JSON safely ---
match = re.search(r"\{.*\}", raw, re.DOTALL)

if not match:
    print(json.dumps({"gaps": []}))
    exit(0)

try:
    parsed = json.loads(match.group())
except json.JSONDecodeError:
    parsed = {"gaps": []}

with open("gaps.json", "w") as f:
    json.dump(parsed, f, indent=2)
